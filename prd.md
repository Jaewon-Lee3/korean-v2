# 🧾 국어 지문 기반 문제 자동 생성기 (OpenRouter + XML → CSV 변환 웹앱)
**v2 – 프롬프트 커스터마이징 기능 포함**

---

## 1️⃣ 프로젝트 개요
사용자가 **국어 지문**을 입력하고 문제 유형(시, 소설, 논설문 등)을 선택하면,  
**사전에 정의된 또는 사용자가 수정한 프롬프트**를 이용해  
**OpenRouter (Google Gemini 2.5 Pro)** 모델을 호출,  
응답받은 **XML 문자열을 정규식으로 파싱해 CSV로 변환 및 다운로드**할 수 있는 서비스.  

배포는 **Vercel(Next.js 기반)** 으로 진행한다.

---

## 2️⃣ 주요 사용자 시나리오
| 단계 | 사용자 동작 | 시스템 동작 |
|------|---------------|---------------|
| 1 | 국어 지문 입력 | 입력 데이터 상태 저장 |
| 2 | 문제 유형 선택 (시, 소설 등) | 해당 유형의 기본 프롬프트 자동 로드 |
| 3 | 필요 시 프롬프트 내용 수정 (커스터마이징) | 수정된 프롬프트를 세션 단위로 저장 |
| 4 | “문제 생성” 클릭 | OpenRouter API 호출 (Gemini 2.5 Pro, temp=0.8) |
| 5 | 모델 응답(XML) 수신 및 문제 형식 미리보기 | 정규식 파싱 후 카드 UI로 표시 |
| 6 | “CSV로 다운로드” 클릭 | CSV 변환 → 파일 다운로드 |

---

## 3️⃣ API 사양
- **엔드포인트:** `https://openrouter.ai/api/v1/chat/completions`  
- **모델:** `google/gemini-2.5-pro`  
- **설정값:**  
  - `temperature: 0.8`  
  - `max_tokens: 기본값`  
  - `retry: 3회 (타임아웃 또는 malformed XML 시)`
- **요청 형식:**
  ```json
  {
    "model": "google/gemini-2.5-pro",
    "temperature": 0.8,
    "messages": [
      {"role": "system", "content": "<문제 유형별 기본 또는 수정된 프롬프트>"},
      {"role": "user", "content": "<입력된 국어 지문>"}
    ]
  }
````

---

## 4️⃣ 프롬프트 관리 및 커스터마이징

### 기본 구조

```json
{
  "시": "다음 시를 기반으로 5지 선다형 문제를 1개 생성하고 XML 형식으로 반환하라...",
  "소설": "다음 소설 지문을 분석하여 이해형 객관식 문제를 XML 형식으로 생성하라...",
  "논설문": "논설문을 바탕으로 논리 판단형 문제를 생성하라..."
}
```

### 커스터마이징 기능

* 사용자는 기본 프롬프트를 **수정 후 저장** 가능.
* 저장 단위:

  * **세션 저장 (localStorage)** → 브라우저 새로고침 시 유지
  * 향후 확장 시 서버 저장 (예: Supabase)
* UI 구성:

  * “기본 프롬프트 불러오기” 버튼
  * “사용자 수정 모드” 토글
  * “저장 / 초기화” 버튼
* 프롬프트 수정 후 문제 생성 시, 수정된 내용이 우선 적용됨.

---

## 5️⃣ 응답 XML 구조 (고정 규격)

### 필수 태그

```xml
<문제>
  <발문><![CDATA[...]]></발문>
  <지문><![CDATA[...]]></지문>
  [<보기><![CDATA[...]]></보기>]
  <선지목록>
    <선지 번호="1"><![CDATA[...]]></선지>
    <선지 번호="2"><![CDATA[...]]></선지>
    <선지 번호="3"><![CDATA[...]]></선지>
    <선지 번호="4"><![CDATA[...]]></선지>
    <선지 번호="5"><![CDATA[...]]></선지>
  </선지목록>
  <정답>
    <정답 번호>③</정답 번호>
    <해설><![CDATA[...]]></해설>
  </정답>
</문제>
```

### 선택 태그

* `<보기>`: 문제 유형에 따라 존재할 수도 있음.
  `<지문>`과 `<선지목록>` 사이에 삽입.

---

## 6️⃣ CSV 변환 매핑

| CSV 컬럼명    | XML 태그 매핑       | 설명     |
| ---------- | --------------- | ------ |
| 제목         | (index)         | 순번     |
| 질문         | `<발문>`          | 문제 발문  |
| 문제 내용      | `<지문>`          | 지문 본문  |
| 해설         | `<정답><해설>`      | 정답 해설  |
| 정답 객관식 번호  | `<정답><정답 번호>`   | 정답 번호  |
| 객관식 선택지1~5 | `<선지 번호="1~5">` | 객관식 보기 |

* 파일명: `questions_YYYYMMDD.csv`
* 인코딩: `UTF-8`

---

## 7️⃣ 파싱 로직

```js
/<발문><!\[CDATA\[(.*?)\]\]><\/발문>/s
/<지문><!\[CDATA\[(.*?)\]\]><\/지문>/s
/<선지 번호="(\d+)"><!\[CDATA\[(.*?)\]\]><\/선지>/g
/<정답 번호>(.*?)<\/정답 번호>/
/<해설><!\[CDATA\[(.*?)\]\]><\/해설>/s
```

→ 추출된 데이터를 JSON으로 구조화 후 `papaparse`로 CSV 변환.

---

## 8️⃣ UI 구성

| 구역    | 요소                     | 설명                      |
| ----- | ---------------------- | ----------------------- |
| 상단    | 제목 + 설명                | 서비스 명칭 및 간단한 안내         |
| 중앙    | 지문 입력 영역               | 텍스트 입력 박스               |
| 좌측    | 문제 유형 선택               | 드롭다운 (시/소설/논설문 등)       |
| 우측    | 프롬프트 편집기               | 커스터마이징 textarea + 저장 버튼 |
| 하단    | [문제 생성], [CSV 다운로드] 버튼 | OpenRouter 호출 및 파일 변환   |
| 결과 영역 | XML 미리보기 + 문제 카드뷰      | 생성된 문제를 보기 쉽게 표시        |

---

## 9️⃣ 기술 스택 및 배포

* **Frontend:** Next.js 14 (App Router), TypeScript
* **UI:** TailwindCSS + shadcn/ui
* **API 연동:** Next.js API Routes
* **CSV 변환:** `papaparse`
* **배포:** Vercel
* **환경변수:** `OPENROUTER_API_KEY`

---

## 🔟 에러 및 예외 처리

| 상황        | 처리 방식                         |
| --------- | ----------------------------- |
| XML 파싱 실패 | 원본 XML 보기 제공 + “출력 형식 오류” 메시지 |
| API 타임아웃  | 3회 재시도 후 실패 안내                |
| CSV 변환 실패 | 에러 다이얼로그 표시                   |
| 프롬프트 미입력  | “프롬프트를 확인하세요” 경고              |

---

## 11️⃣ 확장 포인트

* 사용자별 프롬프트 저장 (로그인 연동)
* CSV 외 JSON / XLSX 다운로드 지원
* 생성 문제 히스토리 저장
* 프롬프트 공유 기능 (링크 기반)
* 여러 문제 한 번에 생성 (Batch Mode)

---

## ✅ 핵심 요약

| 구분      | 내용                                              |
| ------- | ----------------------------------------------- |
| 주요 기능   | 지문 입력 → 문제 유형 선택 → OpenRouter 호출 → XML → CSV 변환 |
| 모델      | Gemini 2.5 Pro (OpenRouter)                     |
| 프롬프트 관리 | 유형별 기본값 + 사용자 커스터마이징                            |
| 결과물     | 문제 미리보기 + CSV 다운로드                              |
| 배포      | Vercel / Next.js 기반                             |


